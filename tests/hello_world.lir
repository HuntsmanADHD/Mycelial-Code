# ============================================================================
# LIR Output for hello_world.mycelial
# Generated by IR Generator Agent (Sonnet)
# Date: 2026-01-01
# ============================================================================

# ----------------------------------------------------------------------------
# Frequency Map
# ----------------------------------------------------------------------------
# greeting -> 1
# response -> 2

# ----------------------------------------------------------------------------
# Struct Definitions
# ----------------------------------------------------------------------------

lir_struct {
  name: "Signal_greeting"
  fields: [
    {
      name: "freq_id"
      offset: 0
      size: 4
      type: I32
    }
    # (padding 4 bytes)
    {
      name: "name"
      offset: 8
      size: 16
      type: Ptr  # String (fat pointer: ptr + len)
    }
  ]
  total_size: 24
  alignment: 8
}

lir_struct {
  name: "Signal_response"
  fields: [
    {
      name: "freq_id"
      offset: 0
      size: 4
      type: I32
    }
    # (padding 4 bytes)
    {
      name: "message"
      offset: 8
      size: 16
      type: Ptr  # String (fat pointer: ptr + len)
    }
  ]
  total_size: 24
  alignment: 8
}

lir_struct {
  name: "AgentState_greeter"
  fields: []
  total_size: 0
  alignment: 1
}

# ----------------------------------------------------------------------------
# Rule Functions
# ----------------------------------------------------------------------------

lir_function {
  name: "greeter_signal_greeting_rule_0"
  params: [
    { name: "state_ptr", type: Ptr }
    { name: "signal_ptr", type: Ptr }
  ]
  return_type: Void

  basic_blocks: [
    {
      label: "bb0"
      instructions: [
        # Access g.name (signal field at offset 8)
        {
          type: "get_field_addr"
          dst: "%tmp0"
          object: "signal_ptr"
          offset: 8
        }
        {
          type: "load"
          dst: "%tmp1"
          addr: "%tmp0"
        }

        # Prepare format string
        {
          type: "const"
          dst: "%tmp2"
          value: "Hello, {}!"
          value_type: Ptr
        }

        # Call runtime_format_string("Hello, {}!", g.name)
        {
          type: "call"
          dst: "%tmp3"
          func: "runtime_format_string"
          args: ["%tmp2", "%tmp1"]
        }

        # Allocate response signal (freq_id=2, size=24)
        {
          type: "call"
          dst: "%tmp4"
          func: "runtime_alloc_signal"
          args: ["2", "24"]
        }

        # Set freq_id field (offset 0)
        {
          type: "store_field"
          object: "%tmp4"
          offset: 0
          src: "2"
        }

        # Set message field (offset 8)
        {
          type: "store_field"
          object: "%tmp4"
          offset: 8
          src: "%tmp3"
        }

        # Emit the signal
        {
          type: "call"
          dst: ""
          func: "runtime_emit_signal"
          args: ["state_ptr", "%tmp4"]
        }
      ]

      terminator: {
        type: "return"
        value: ""
      }
    }
  ]
}

# ----------------------------------------------------------------------------
# Dispatch Function
# ----------------------------------------------------------------------------

lir_function {
  name: "greeter_dispatch"
  params: [
    { name: "state_ptr", type: Ptr }
    { name: "signal_ptr", type: Ptr }
  ]
  return_type: Void

  basic_blocks: [
    # Entry block: Load freq_id and route
    {
      label: "bb0"
      instructions: [
        # Load freq_id from signal (offset 0)
        {
          type: "load_field"
          dst: "%tmp0"
          object: "signal_ptr"
          offset: 0
        }

        # Check if freq_id == 1 (greeting)
        {
          type: "cmp_eq"
          dst: "%tmp1"
          lhs: "%tmp0"
          rhs: "1"
        }
      ]

      terminator: {
        type: "branch"
        condition: "%tmp1"
        true_label: "bb1"
        false_label: "bb2"
      }
    }

    # Handle greeting frequency
    {
      label: "bb1"
      instructions: [
        {
          type: "call"
          dst: ""
          func: "greeter_signal_greeting_rule_0"
          args: ["state_ptr", "signal_ptr"]
        }
      ]

      terminator: {
        type: "return"
        value: ""
      }
    }

    # No matching frequency
    {
      label: "bb2"
      instructions: []

      terminator: {
        type: "return"
        value: ""
      }
    }
  ]
}

# ============================================================================
# End of LIR Output
# ============================================================================

# VALIDATION NOTES:
# ✅ Struct layouts match IR spec Section 10.1
# ✅ Function names follow {hyphal}_signal_{frequency}_rule_{idx} pattern
# ✅ Parameters correct (state_ptr, signal_ptr)
# ✅ SSA form maintained (%tmp0, %tmp1, %tmp2, ...)
# ✅ Instruction sequence matches expected output
# ✅ Terminators correct (return, branch)
# ✅ Field offsets accurate (freq_id at 0, name/message at 8)
# ✅ Signal allocation uses correct freq_id and size
# ✅ Dispatch routes based on freq_id comparison
#
# RUNTIME FUNCTIONS REQUIRED:
# - runtime_format_string(template: Ptr, arg: Ptr) -> Ptr
# - runtime_alloc_signal(freq_id: I32, size: I32) -> Ptr
# - runtime_emit_signal(state_ptr: Ptr, signal_ptr: Ptr) -> Void
