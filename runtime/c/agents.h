/*
 * Mycelial Signal Runtime - Agent Registry & Topology
 * M2 Phase 4 Implementation
 *
 * Provides enhanced agent registration and network topology initialization.
 * Builds on signal.h Agent struct with named agents and topology support.
 *
 * Based on M2_TOPOLOGY_COMPILATION_SPEC.md
 */

#ifndef MYCELIAL_AGENTS_H
#define MYCELIAL_AGENTS_H

#include <stdint.h>
#include <stddef.h>

/* Forward declarations */
struct Signal;
struct SignalQueue;
struct DispatchTable;
struct RoutingTable;

/* =============================================================================
 * ENHANCED AGENT STRUCTURE
 *
 * Extends the basic Agent with name and topology information.
 * ============================================================================= */

/*
 * Agent metadata with name and full integration
 *
 * Layout: 64 bytes
 */
typedef struct AgentInfo {
    uint32_t agent_id;              /* 0x00: Unique agent ID */
    uint32_t agent_type;            /* 0x04: Agent type (for categorization) */
    const char* name;               /* 0x08: Agent name (for debugging) */
    void* state;                    /* 0x10: Pointer to agent state struct */
    size_t state_size;              /* 0x18: Size of state struct */
    struct SignalQueue* queue;      /* 0x20: Incoming signal queue */
    struct DispatchTable* dispatch; /* 0x28: Signal handlers */
    uint32_t flags;                 /* 0x30: Agent flags */
    uint32_t signal_count;          /* 0x34: Signals processed */
    uint32_t queue_capacity;        /* 0x38: Queue size for this agent */
    uint32_t reserved;              /* 0x3C: Padding */
} AgentInfo;

/* Agent flags */
#define AGENT_FLAG_ACTIVE           0x0001  /* Agent is active */
#define AGENT_FLAG_INITIALIZED      0x0002  /* State initialized */
#define AGENT_FLAG_HAS_HANDLERS     0x0004  /* Has registered handlers */

/* =============================================================================
 * AGENT REGISTRY (ENHANCED)
 *
 * Global registry for all agents in the network.
 * ============================================================================= */

typedef struct AgentRegistry2 {
    AgentInfo* agents;              /* 0x00: Array of agent info */
    uint32_t agent_count;           /* 0x08: Number of registered agents */
    uint32_t capacity;              /* 0x0C: Maximum agents */
    const char** agent_names;       /* 0x10: Lookup table: ID -> name */
    uint32_t* name_to_id;           /* 0x18: Hash table: name -> ID */
    uint32_t name_table_size;       /* 0x20: Size of name hash table */
    struct RoutingTable* routing;   /* 0x24: Routing table for this network */
    uint32_t flags;                 /* 0x28: Registry flags */
    uint32_t total_signals;         /* 0x2C: Stats: total signals processed */
} AgentRegistry2;

/* =============================================================================
 * FREQUENCY REGISTRY
 *
 * Maps frequency names to IDs for debugging and runtime lookup.
 * ============================================================================= */

typedef struct FrequencyInfo {
    uint32_t frequency_id;          /* Unique frequency ID */
    const char* name;               /* Frequency name (e.g., "tokens", "ast") */
    uint32_t payload_size;          /* Expected payload size (0 = variable) */
    uint32_t flags;                 /* Frequency flags */
} FrequencyInfo;

typedef struct FrequencyRegistry {
    FrequencyInfo* frequencies;     /* Array of frequency info */
    uint32_t frequency_count;       /* Number of registered frequencies */
    uint32_t capacity;              /* Maximum frequencies */
} FrequencyRegistry;

/* =============================================================================
 * SOCKET DEFINITION
 *
 * Represents a socket connection at compile time.
 * Used to build routing tables.
 * ============================================================================= */

typedef struct SocketDef {
    uint32_t source_agent_id;       /* Source agent */
    uint32_t frequency_id;          /* Signal frequency */
    uint32_t dest_agent_id;         /* Destination agent */
    uint32_t flags;                 /* Socket flags */
} SocketDef;

/* =============================================================================
 * NETWORK TOPOLOGY
 *
 * Complete network definition generated by compiler.
 * ============================================================================= */

typedef struct NetworkTopology {
    AgentInfo* agents;              /* Agent definitions */
    uint32_t agent_count;           /* Number of agents */
    SocketDef* sockets;             /* Socket definitions */
    uint32_t socket_count;          /* Number of sockets */
    FrequencyInfo* frequencies;     /* Frequency definitions */
    uint32_t frequency_count;       /* Number of frequencies */
    const char* network_name;       /* Network name (for debugging) */
    uint32_t flags;                 /* Network flags */
} NetworkTopology;

/* =============================================================================
 * ERROR CODES
 * ============================================================================= */

#define TOPOLOGY_OK                 0
#define TOPOLOGY_ERR_NULL_POINTER   1
#define TOPOLOGY_ERR_ALLOC_FAILED   2
#define TOPOLOGY_ERR_AGENT_EXISTS   3
#define TOPOLOGY_ERR_AGENT_NOT_FOUND 4
#define TOPOLOGY_ERR_INVALID_SOCKET 5
#define TOPOLOGY_ERR_CAPACITY       6

/* =============================================================================
 * REGISTRY FUNCTIONS
 * ============================================================================= */

/*
 * Create a new agent registry
 *
 * @param capacity: Maximum number of agents
 * @return: Pointer to registry, or NULL on failure
 */
AgentRegistry2* registry_create(uint32_t capacity);

/*
 * Destroy registry and free all resources
 *
 * @param registry: Registry to destroy
 */
void registry_destroy(AgentRegistry2* registry);

/*
 * Register an agent in the registry
 *
 * @param registry: Agent registry
 * @param agent_id: Unique agent ID
 * @param name: Agent name (will be copied)
 * @param state: Pointer to agent state (or NULL)
 * @param state_size: Size of state struct
 * @param queue: Signal queue (or NULL to create)
 * @param dispatch: Dispatch table (or NULL)
 * @return: TOPOLOGY_OK on success
 */
int registry_register(AgentRegistry2* registry, uint32_t agent_id,
                      const char* name, void* state, size_t state_size,
                      struct SignalQueue* queue, struct DispatchTable* dispatch);

/*
 * Get agent info by ID
 *
 * @param registry: Agent registry
 * @param agent_id: Agent ID to look up
 * @return: Pointer to AgentInfo, or NULL if not found
 */
AgentInfo* registry_get_agent(AgentRegistry2* registry, uint32_t agent_id);

/*
 * Get agent by name
 *
 * @param registry: Agent registry
 * @param name: Agent name
 * @return: Pointer to AgentInfo, or NULL if not found
 */
AgentInfo* registry_get_agent_by_name(AgentRegistry2* registry, const char* name);

/*
 * Get agent's signal queue
 *
 * @param registry: Agent registry
 * @param agent_id: Agent ID
 * @return: Signal queue pointer, or NULL if not found
 */
struct SignalQueue* registry_get_queue(AgentRegistry2* registry, uint32_t agent_id);

/*
 * Get agent's dispatch table
 *
 * @param registry: Agent registry
 * @param agent_id: Agent ID
 * @return: Dispatch table pointer, or NULL if not found
 */
struct DispatchTable* registry_get_dispatch(AgentRegistry2* registry, uint32_t agent_id);

/*
 * Get number of registered agents
 */
uint32_t registry_get_count(AgentRegistry2* registry);

/* =============================================================================
 * FREQUENCY REGISTRY FUNCTIONS
 * ============================================================================= */

/*
 * Create frequency registry
 */
FrequencyRegistry* frequency_registry_create(uint32_t capacity);

/*
 * Register a frequency
 */
int frequency_register(FrequencyRegistry* registry, uint32_t frequency_id,
                       const char* name, uint32_t payload_size);

/*
 * Look up frequency by ID
 */
FrequencyInfo* frequency_get(FrequencyRegistry* registry, uint32_t frequency_id);

/*
 * Look up frequency by name
 */
FrequencyInfo* frequency_get_by_name(FrequencyRegistry* registry, const char* name);

/* =============================================================================
 * TOPOLOGY INITIALIZATION FUNCTIONS
 * ============================================================================= */

/*
 * Initialize network from topology definition
 *
 * This is the main initialization function. It:
 * 1. Creates agent registry
 * 2. Allocates and initializes agent states
 * 3. Creates signal queues for each agent
 * 4. Builds routing tables from socket definitions
 *
 * @param topology: Network topology definition
 * @return: Initialized registry, or NULL on failure
 */
AgentRegistry2* topology_init(NetworkTopology* topology);

/*
 * Initialize a single agent
 *
 * @param registry: Agent registry
 * @param info: Agent info to initialize
 * @return: TOPOLOGY_OK on success
 */
int topology_init_agent(AgentRegistry2* registry, AgentInfo* info);

/*
 * Build routing tables from socket definitions
 *
 * @param registry: Agent registry (with routing table)
 * @param sockets: Array of socket definitions
 * @param socket_count: Number of sockets
 * @return: TOPOLOGY_OK on success
 */
int topology_build_routes(AgentRegistry2* registry, SocketDef* sockets,
                          uint32_t socket_count);

/*
 * Resolve all queue pointers in routing table
 *
 * Call after all agents are registered.
 */
void topology_resolve_routes(AgentRegistry2* registry);

/*
 * Shutdown and cleanup network
 *
 * @param registry: Registry to shutdown
 */
void topology_shutdown(AgentRegistry2* registry);

/* =============================================================================
 * AGENT STATE HELPERS
 * ============================================================================= */

/*
 * Allocate and zero-initialize agent state
 *
 * @param state_size: Size of state struct in bytes
 * @return: Pointer to zeroed state, or NULL on failure
 */
void* agent_state_alloc(size_t state_size);

/*
 * Free agent state
 *
 * @param state: State to free
 * @param state_size: Size of state struct
 */
void agent_state_free(void* state, size_t state_size);

/* =============================================================================
 * DEBUG FUNCTIONS
 * ============================================================================= */

/*
 * Print registry contents (for debugging)
 */
void registry_print(AgentRegistry2* registry);

/*
 * Get agent name by ID
 */
const char* registry_get_name(AgentRegistry2* registry, uint32_t agent_id);

#endif /* MYCELIAL_AGENTS_H */
